#!/bin/bash

# Set variables
DOCKER_USERNAME="confusedcrib"  # Docker Hub username
IMAGE_NAME="vulnerable-ssh-server"
IMAGE_TAG="latest"

# Build the Docker image
echo "Building Docker image..."
docker build -t $IMAGE_NAME:$IMAGE_TAG ..

# Tag the image for Docker Hub
echo "Tagging image for Docker Hub..."
docker tag $IMAGE_NAME:$IMAGE_TAG $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG

# Push to Docker Hub
echo "Pushing to Docker Hub..."
docker push $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG

# Update the deployment manifest with the correct image
sed -i "s|image: vulnerable-ssh-server:latest|image: $DOCKER_USERNAME/$IMAGE_NAME:$IMAGE_TAG|" deployment.yaml

# Create namespace and deploy to Kubernetes
echo "Deploying to Kubernetes..."
kubectl apply -f deployment.yaml

# Wait for deployment to be ready
echo "Waiting for deployment to be ready..."
kubectl -n erlang rollout status deployment/vulnerable-ssh-server

# Get service information
echo "Service information:"
kubectl -n erlang get svc vulnerable-ssh-server 