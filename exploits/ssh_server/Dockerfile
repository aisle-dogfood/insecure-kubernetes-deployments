FROM elixir:1.14-slim

# Install debugging tools and SSH components
RUN apt-get update && apt-get install -y \
    net-tools \
    iputils-ping \
    openssh-client \
    openssh-server \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install hex package manager
RUN mix local.hex --force

# Copy application code
COPY . .

# Install dependencies and compile
RUN mix deps.get && \
    mix compile

# Create SSH keys directory and generate host keys
RUN mkdir -p /root/ssh_keys && \
    ssh-keygen -t rsa -f /root/ssh_keys/ssh_host_rsa_key -N "" && \
    ssh-keygen -t dsa -f /root/ssh_keys/ssh_host_dsa_key -N "" && \
    ssh-keygen -t ecdsa -f /root/ssh_keys/ssh_host_ecdsa_key -N ""

# Add startup script
RUN chmod +x /app/start.sh

CMD ["/app/start.sh"]
